<?php
namespace App\Controllers;

use Core\Controller;
use App\Models\User;
use App\Models\Dashboard;
use App\Models\Announcement;

class AdminController extends Controller {
    private $userModel;
    private $dashboardModel;
<<<<<<< HEAD
    private $databaseModel;
=======
    private $announcementModel;
>>>>>>> ab6ae59bdf34577d5ae1b6dfdbdb299fb1d59159

    public function __construct() {
        parent::__construct();
        $this->userModel = new User();
        $this->dashboardModel = new Dashboard();
<<<<<<< HEAD
        $this->databaseModel = new \App\Models\Database();
=======
        $this->announcementModel = new Announcement();
>>>>>>> ab6ae59bdf34577d5ae1b6dfdbdb299fb1d59159
        
        // Require authentication for all admin routes except login
        $action = $_GET['url'] ?? '';
        if ($action !== 'admin/login' && $action !== 'admin/authenticate') {
            $this->requireAuth();
        }
    }

    /**
     * Manage announcements
     */
    public function manageAnnouncements() {
        try {
            $announcements = $this->announcementModel->getAllAnnouncements();

            $data = [
                'pageTitle' => 'Manage Announcements - ' . SITE_NAME,
                'username' => $_SESSION['username'],
                'currentPage' => 'announcements',
                'layout' => 'admin',
                'announcements' => $announcements
            ];

            // Get flash messages if any
            $data['error'] = $this->getFlashMessage('error');
            $data['success'] = $this->getFlashMessage('success');

            $this->render('admin/manage_announcements', $data);
        } catch (\Exception $e) {
            error_log("Error in AdminController->manageAnnouncements(): " . $e->getMessage());
            $this->setFlashMessage('error', 'An error occurred while loading announcements.');
            $this->redirect('/admin/dashboard');
        }
    }

        /**
     * Store a new announcement
     */
    public function storeAnnouncement() {
        try {
            if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
                throw new \Exception('Invalid request method');
            }

            // Get and sanitize inputs
            $title = filter_var(trim($_POST['title'] ?? ''), FILTER_SANITIZE_STRING);
            $content = filter_var(trim($_POST['content'] ?? ''), FILTER_SANITIZE_STRING);
            $datePosted = filter_var(trim($_POST['date_posted'] ?? ''), FILTER_SANITIZE_STRING);
            $isActive = isset($_POST['is_active']) ? 1 : 0;

            // Validate inputs
            if (empty($title) || empty($content) || empty($datePosted)) {
                throw new \Exception('Please fill in all required fields');
            }

            // Validate date format
            if (!strtotime($datePosted)) {
                throw new \Exception('Invalid date format');
            }

            // Create announcement
            $data = [
                'title' => $title,
                'content' => $content,
                'date_posted' => $datePosted,
                'is_active' => $isActive
            ];

            $result = $this->announcementModel->create($data);
            if (!$result) {
                throw new \Exception('Failed to create announcement');
            }

            $this->setFlashMessage('success', 'Announcement created successfully');

        } catch (\Exception $e) {
            error_log("Error in AdminController->storeAnnouncement(): " . $e->getMessage());
            $this->setFlashMessage('error', 'Error creating announcement: ' . $e->getMessage());
        }

        $this->redirect('/admin/announcements');
    }

    /**
     * Get announcement data for editing
     */
    public function getAnnouncement($id) {
        try {
            $announcement = $this->announcementModel->getById($id);
            if (!$announcement) {
                http_response_code(404);
                echo json_encode(['error' => 'Announcement not found']);
                return;
            }

            echo json_encode($announcement);

        } catch (\Exception $e) {
            error_log("Error in AdminController->getAnnouncement(): " . $e->getMessage());
            http_response_code(500);
            echo json_encode(['error' => 'Error fetching announcement']);
        }
    }

    /**
     * Update an existing announcement
     */
    public function updateAnnouncement($id) {
        try {
            if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
                throw new \Exception('Invalid request method');
            }

            // Validate and sanitize inputs
            $title = trim($_POST['title'] ?? '');
            $content = trim($_POST['content'] ?? '');
            $datePosted = trim($_POST['date_posted'] ?? '');
            $isActive = isset($_POST['is_active']) ? 1 : 0;

            if (empty($title) || empty($content) || empty($datePosted)) {
                throw new \Exception('Please fill in all required fields');
            }

            // Update announcement
            $data = [
                'title' => $title,
                'content' => $content,
                'date_posted' => $datePosted,
                'is_active' => $isActive
            ];

            $this->announcementModel->update($id, $data);
            $this->setFlashMessage('success', 'Announcement updated successfully');

        } catch (\Exception $e) {
            error_log("Error in AdminController->updateAnnouncement(): " . $e->getMessage());
            $this->setFlashMessage('error', 'Error updating announcement: ' . $e->getMessage());
        }

        $this->redirect('/admin/announcements');
    }

    /**
     * Delete an announcement
     */
    public function deleteAnnouncement($id) {
        try {
            $this->announcementModel->delete($id);
            $this->setFlashMessage('success', 'Announcement deleted successfully');
        } catch (\Exception $e) {
            error_log("Error in AdminController->deleteAnnouncement(): " . $e->getMessage());
            $this->setFlashMessage('error', 'Error deleting announcement');
        }

        $this->redirect('/admin/announcements');
    }

    /**
     * Toggle announcement active status
     */
    public function toggleAnnouncementStatus($id) {
        try {
            $this->announcementModel->toggleStatus($id);
            echo json_encode(['success' => true]);
        } catch (\Exception $e) {
            error_log("Error in AdminController->toggleAnnouncementStatus(): " . $e->getMessage());
            http_response_code(500);
            echo json_encode(['success' => false, 'error' => 'Error toggling announcement status']);
        }
    }

    /**
     * Display admin login page
     */
    public function login() {
        // Redirect to dashboard if already logged in
        if (isset($_SESSION['user_id'])) {
            header('Location: ' . BASE_URL . '/admin/dashboard');
            return;
        }

        $data = [
            'pageTitle' => 'Admin Login - ' . SITE_NAME,
            'error' => $this->getFlashMessage('error')
        ];

        $this->renderPartial('admin/login', $data);
    }

    /**
     * Handle login form submission
     */
    public function authenticate() {
        try {
            if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
                http_response_code(405);
                header('Location: ' . BASE_URL . '/admin/login');
                return;
            }

            $username = trim($_POST['username'] ?? '');
            $password = $_POST['password'] ?? '';

            // Validate inputs
            if (empty($username) || empty($password)) {
                $this->setFlashMessage('error', 'Please enter both username and password.');
                header('Location: ' . BASE_URL . '/admin/login');
                return;
            }

            // Get user from database
            $user = $this->userModel->getUserByUsername($username);
            if (!$user || !$this->userModel->verifyPassword($password, $user['password_hash'])) {
                $this->setFlashMessage('error', 'Invalid username or password.');
                header('Location: ' . BASE_URL . '/admin/login');
                return;
            }

            // Start session and store user data
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['username'] = $user['username'];
            $_SESSION['role'] = $user['role'];
            $_SESSION['last_activity'] = time();

            // Redirect to dashboard
            header('Location: ' . BASE_URL . '/admin/dashboard');

        } catch (\Exception $e) {
            error_log("Error in AdminController->authenticate(): " . $e->getMessage());
            $this->setFlashMessage('error', 'An error occurred during login.');
            header('Location: ' . BASE_URL . '/admin/login');
        }
    }

    /**
     * Handle logout
     */
    public function logout() {
        // Destroy all session data
        session_destroy();
        
        // Redirect to login page with success message
        $this->setFlashMessage('success', 'You have been successfully logged out.');
        header('Location: ' . BASE_URL . '/admin/login');
    }

    /**
     * Display admin dashboard
     */
    public function dashboard() {
        try {
            // Get dashboard stats
            $stats = $this->dashboardModel->getStats();
            
            // Get recent activity
            $recentActivity = $this->dashboardModel->getRecentActivity(5);

            $data = [
                'pageTitle' => 'Admin Dashboard - ' . SITE_NAME,
                'username' => $_SESSION['username'],
                'currentPage' => 'dashboard',
                'layout' => 'admin',
                'stats' => $stats,
                'recentActivity' => $recentActivity
            ];

            $this->render('admin/dashboard', $data);
        } catch (\Exception $e) {
            error_log("Error in AdminController->dashboard(): " . $e->getMessage());
            $data = [
                'pageTitle' => 'Admin Dashboard - ' . SITE_NAME,
                'username' => $_SESSION['username'],
                'currentPage' => 'dashboard',
                'layout' => 'admin',
                'stats' => [
                    'announcements' => 0,
                    'pending_contacts' => 0,
                    'ebooks' => 0,
                    'ejournals' => 0,
                    'databases' => 0
                ],
                'recentActivity' => [],
                'error' => 'An error occurred while loading the dashboard.'
            ];
            $this->render('admin/dashboard', $data);
        }
    }

    /**
     * Require authentication middleware
     * @return void
     */
    protected function requireAuth(): void {
        if (!isset($_SESSION['user_id'])) {
            $this->setFlashMessage('error', 'Please log in to access the admin area.');
            header('Location: ' . BASE_URL . '/admin/login');
            exit;
        }

        // Check session timeout (30 minutes)
        if (time() - $_SESSION['last_activity'] > 1800) {
            session_destroy();
            $this->setFlashMessage('error', 'Your session has expired. Please log in again.');
            header('Location: ' . BASE_URL . '/admin/login');
            exit;
        }

        // Update last activity time
        $_SESSION['last_activity'] = time();
    }

    /**
     * Set a flash message
     */
    private function setFlashMessage(string $type, string $message): void {
        $_SESSION['flash_' . $type] = $message;
    }

    /**
     * Get and clear a flash message
     */
    private function getFlashMessage(string $type): ?string {
        $message = $_SESSION['flash_' . $type] ?? null;
        unset($_SESSION['flash_' . $type]);
        return $message;
    }

    /**
     * Display database management page
     */
    public function manageDatabases() {
        try {
            $databases = $this->databaseModel->getAllDatabases();
            $categories = $this->databaseModel->getAllCategories();

            $data = [
                'pageTitle' => 'Manage Databases - ' . SITE_NAME,
                'username' => $_SESSION['username'],
                'currentPage' => 'manage_databases',
                'layout' => 'admin',
                'databases' => $databases,
                'categories' => $categories,
                'success' => $this->getFlashMessage('success'),
                'error' => $this->getFlashMessage('error')
            ];

            $this->render('admin/manage_databases', $data);
        } catch (\Exception $e) {
            error_log("Error in AdminController->manageDatabases(): " . $e->getMessage());
            $this->setFlashMessage('error', 'An error occurred while loading the databases.');
            header('Location: ' . BASE_URL . '/admin/dashboard');
        }
    }

    /**
     * Create a new database entry
     */
    public function createDatabase() {
        try {
            if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
                http_response_code(405);
                header('Location: ' . BASE_URL . '/admin/manage-databases');
                return;
            }

            $data = [
                'name' => trim($_POST['name'] ?? ''),
                'description' => trim($_POST['description'] ?? ''),
                'url' => trim($_POST['url'] ?? ''),
                'category' => trim($_POST['category'] ?? ''),
                'icon_path' => null // Placeholder for future icon upload functionality
            ];

            $this->databaseModel->create($data);
            $this->setFlashMessage('success', 'Database link added successfully.');

        } catch (\InvalidArgumentException $e) {
            // Validation errors
            $this->setFlashMessage('error', $e->getMessage());
        } catch (\Exception $e) {
            error_log("Error in AdminController->createDatabase(): " . $e->getMessage());
            $this->setFlashMessage('error', 'An error occurred while creating the database entry.');
        }

        header('Location: ' . BASE_URL . '/admin/manage-databases');
    }
}